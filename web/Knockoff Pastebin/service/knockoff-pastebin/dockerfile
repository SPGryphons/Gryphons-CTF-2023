FROM python:3.11-slim-bookworm

COPY app /app

COPY flag.txt /flag.txt

RUN python3 -m pip install -r /app/requirements.txt

RUN groupadd -r app && \
    useradd -r -g app app

RUN chown -R app:app /app && \
    chown -R app:app /flag.txt && \
    chmod 440 /flag.txt && \
    chmod -R 750 /app && \
    chmod -R 770 /app/keys && \
    chmod -R 770 /app/uploads

# Run as the app user
USER app

# Set the working directory
WORKDIR /app

EXPOSE 1337

ENV PYTHONDONTWRITEBYTECODE=1

# Run the app
CMD ["flask", "run", "--host=0.0.0.0", "--port=1337", "--no-reload", "--debug"]